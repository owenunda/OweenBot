name: CI/CD Docker Build and Deploy

on:
  push:
    branches:
      - main 

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Login a Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }} 
          password: ${{ secrets.DOCKER_PASSWORD }} 

      # 2. Build y Push de la Imagen
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Usa el nombre completo de la imagen (oween/oweenbot:latest)
          tags: ${{ secrets.DOCKER_USERNAME }}/oweenbot:latest 
          
      # 3. Define la Variable de la Imagen
      # (Necesaria para construir el JSON del Webhook)
      - name: Set Image Name Variable
        id: image_name_vars
        run: |
          # Variable con el nombre que Dokploy debe descargar
          echo "DOCKER_IMAGE=${{ secrets.DOCKER_USERNAME }}/oweenbot:latest" >> $GITHUB_OUTPUT

      # 4. Trigger Dokploy Webhook con Payload JSON (La Solución al error)
      - name: Trigger Dokploy Deployment Webhook with JSON Payload
        env:
          DOKPLOY_WEBHOOK_URL: ${{ secrets.DOKPLOY_WEBHOOK }}
          IMAGE_NAME: ${{ steps.image_name_vars.outputs.DOCKER_IMAGE }} 
        run: |
           echo "Disparando Webhook a Dokploy con imagen: $IMAGE_NAME"
           
           # Envía Content-Type: application/json y el cuerpo: {"image": "oween/oweenbot:latest"}
           curl -X POST \
                --fail \
                -v \
                -L \
                -H "Content-Type: application/json" \
                -d "{\"image\":\"$IMAGE_NAME\"}" \
                "$DOKPLOY_WEBHOOK_URL"
           
           echo "✅ Señal de despliegue enviada. Revisa la pestaña Deployments en Dokploy."